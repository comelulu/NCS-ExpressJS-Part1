# 18. Params with Middleware

## âœ… ê°œìš”: `app.param()`ì´ë€?

- íŠ¹ì • `:param`ì´ URLì— í¬í•¨ë˜ì–´ ìˆì„ ë•Œ, **ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ë¯¸ë“¤ì›¨ì–´**ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
- í•´ë‹¹ param ê°’ì„ ì‚¬ìš©í•˜ì—¬ DB ì¡°íšŒ, ê¶Œí•œ ê²€ì¦ ë“±ì˜ ì „ì²˜ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ê²°ê³¼ë¥¼ `req` ê°ì²´ì— ë‹´ì•„ í›„ì† ë¼ìš°íŠ¸ì—ì„œ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

---

## ğŸ›  ì „ì²´ ì½”ë“œ

```js
const express = require("express");
const app = express();

/*
==========================================================
ğŸ§© app.param("userId", callback)
----------------------------------------------------------
- ë¼ìš°íŠ¸ ê²½ë¡œì— :userIdê°€ ì‚¬ìš©ë  ë•Œë§ˆë‹¤ ì´ ë¯¸ë“¤ì›¨ì–´ê°€ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤.
- ì£¼ë¡œ DBì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¯¸ë¦¬ ì¡°íšŒí•˜ê±°ë‚˜ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
*/
app.param("userId", (req, res, next, id) => {
  // "userId"ëŠ” ê²½ë¡œ íŒŒë¼ë¯¸í„° (:userId)ì˜ ì‹¤ì œ ê°’
  const user = getUserById(id); // ê°€ìƒì˜ DB ì¡°íšŒ í•¨ìˆ˜

  // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ì—ëŸ¬ ì‘ë‹µ
  if (!user) {
    return res.status(404).send("User not found");
  }

  // req.userì— ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ì—¬ ì´í›„ ë¼ìš°íŠ¸ì—ì„œ ì‚¬ìš©
  req.user = user;

  next(); // ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ ë˜ëŠ” ë¼ìš°í„°ë¡œ ì§„í–‰
});

/*
==========================================================
ğŸ“„ GET /users/:userId
----------------------------------------------------------
- :userIdê°€ URLì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ìœ„ì˜ app.paramì´ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤.
- req.userì—ëŠ” ì‚¬ìš©ì ì •ë³´ê°€ ì´ë¯¸ ë“¤ì–´ìˆëŠ” ìƒíƒœì…ë‹ˆë‹¤.
*/
app.get("/users/:userId", (req, res) => {
  res.send(req.user); // ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ
});

/*
==========================================================
ğŸ“„ GET /blogs/:userId
----------------------------------------------------------
- ë‹¤ë¥¸ ê²½ë¡œì—ì„œë„ :userIdê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ app.paramì´ ë™ì¼í•˜ê²Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
- ì¦‰, ì¤‘ë³µ ì—†ì´ ì‚¬ìš©ì ì „ì²˜ë¦¬ ë¡œì§ì„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
*/
app.get("/blogs/:userId", (req, res) => {
  res.send({
    message: `${req.user.name}ë‹˜ì˜ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.`,
    user: req.user,
  });
});

/*
==========================================================
ğŸ“¦ ê°€ìƒì˜ ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜ (ì‹¤ì œ DB ëŒ€ì‹  í•˜ë“œì½”ë”©)
*/
function getUserById(id) {
  const users = {
    "1": { id: 1, name: "Alice", role: "Admin" },
    "2": { id: 2, name: "Bob", role: "User" },
  };
  return users[id];
}

// âœ… ì„œë²„ ì‹¤í–‰
const PORT = 3000;
app.listen(PORT, () => console.log(`âœ… Server running on port ${PORT}`));
```

---

## ğŸ§­ ì‹¤ì œ ë™ì‘ íë¦„ ì‹œê°í™”

### ğŸ¯ ìš”ì²­: `GET /users/1`

```js
í´ë¼ì´ì–¸íŠ¸ ìš”ì²­: GET /users/1
â”‚
â”œâ”€ app.param("userId", ...)
â”‚   â””â”€ id = "1"
â”‚   â””â”€ getUserById("1") â†’ { id: 1, name: "Alice", role: "Admin" }
â”‚   â””â”€ req.user = { id: 1, name: "Alice", ... }
â”‚   â””â”€ next()
â”‚
â”œâ”€ app.get("/users/:userId")
â”‚   â””â”€ res.send(req.user)
â”‚
â””â”€ ì‘ë‹µ:
{
  "id": 1,
  "name": "Alice",
  "role": "Admin"
}
```

---

### ğŸ¯ ìš”ì²­: `GET /blogs/2`

```js
í´ë¼ì´ì–¸íŠ¸ ìš”ì²­: GET /blogs/2
â”‚
â”œâ”€ app.param("userId", ...)
â”‚   â””â”€ id = "2"
â”‚   â””â”€ getUserById("2") â†’ { id: 2, name: "Bob", role: "User" }
â”‚   â””â”€ req.user = { id: 2, name: "Bob", ... }
â”‚   â””â”€ next()
â”‚
â”œâ”€ app.get("/blogs/:userId")
â”‚   â””â”€ res.send({
â”‚         message: "Bobë‹˜ì˜ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.",
â”‚         user: req.user
â”‚       })
â”‚
â””â”€ ì‘ë‹µ:
{
  "message": "Bobë‹˜ì˜ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.",
  "user": {
    "id": 2,
    "name": "Bob",
    "role": "User"
  }
}
```

---

### ğŸ”¥ ìš”ì²­: `GET /users/999` â†’ ì‚¬ìš©ì ì—†ìŒ

```js
í´ë¼ì´ì–¸íŠ¸ ìš”ì²­: GET /users/999
â”‚
â”œâ”€ app.param("userId", ...)
â”‚   â””â”€ getUserById("999") â†’ undefined
â”‚   â””â”€ return res.status(404).send("User not found")
â”‚
â””â”€ ìš”ì²­ ì¢…ë£Œë¨ (ë¼ìš°íŠ¸ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ)
```

---

## ğŸ§  ì‹¤ë¬´ ê°œë… ë¹„ìœ 

| êµ¬ì¡° | ë¹„ìœ  |
|------|------|
| `app.param("userId", fn)` | ëª¨ë“  ê²½ë¡œì— ê³µí†µ ì ìš©ë˜ëŠ” **ë¯¸ë¦¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹œìŠ¤í…œ** |
| `req.user` | ì‚¬ìš©ìì˜ ì •ë³´ ì¹´ë“œ: ì´í›„ ë¡œì§ì—ì„œ ì–¸ì œë“  êº¼ë‚´ ì“¸ ìˆ˜ ìˆìŒ |
| ì¬ì‚¬ìš©ì„± | í•œ ë²ˆ ì •ì˜í•œ íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë‹¤ì–‘í•œ ë¼ìš°íŠ¸ì—ì„œ **ì¤‘ë³µ ì—†ì´ ì¬ì‚¬ìš©** ê°€ëŠ¥ |

---

## ğŸ“˜ ì£¼ìš” ê°œë… ìš”ì•½

| ìš©ì–´ | ì„¤ëª… |
|------|------|
| `:userId` | ë¼ìš°íŠ¸ ê²½ë¡œì˜ ë™ì  íŒŒë¼ë¯¸í„° |
| `app.param()` | í•´ë‹¹ íŒŒë¼ë¯¸í„°ê°€ í¬í•¨ëœ ìš”ì²­ë§ˆë‹¤ ìë™ ì‹¤í–‰ë˜ëŠ” ì „ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ |
| `req.params.userId` | URLì—ì„œ ì¶”ì¶œí•œ ì‹¤ì œ íŒŒë¼ë¯¸í„° ê°’ |
| `req.user` | ì „ì²˜ë¦¬ëœ ì‚¬ìš©ì ì •ë³´ ì €ì¥ì†Œ |
| ì¬ì‚¬ìš©ì„± | ëª¨ë“  ë¼ìš°íŠ¸ì—ì„œ `:userId`ê°€ ë“¤ì–´ì˜¤ë©´ ê°™ì€ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë¨ |

---

## âœ… ì§ì ‘ í…ŒìŠ¤íŠ¸ ì£¼ì†Œ

| ìš”ì²­ URL | ì„¤ëª… |
|----------|------|
| `http://localhost:3000/users/1` | ì‚¬ìš©ì Alice ì •ë³´ |
| `http://localhost:3000/blogs/2` | ì‚¬ìš©ì Bobì˜ ë¸”ë¡œê·¸ |
| `http://localhost:3000/users/999` | ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì (404 ì‘ë‹µ) |

---

## ğŸ”§ í™•ì¥ ì•„ì´ë””ì–´

- `app.param()`ìœ¼ë¡œ ì‚¬ìš©ì ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„í•˜ê¸°
- `req.user.role === "Admin"`ì„ í™œìš©í•œ ê´€ë¦¬ì ì „ìš© ë¼ìš°íŠ¸ ë¶„ê¸°
- ë¸”ë¡œê·¸ ì™¸ì—ë„ ëŒ“ê¸€, ì¥ë°”êµ¬ë‹ˆ, ì£¼ë¬¸ ë“±ìœ¼ë¡œ ì¬ì‚¬ìš© ê°€ëŠ¥


