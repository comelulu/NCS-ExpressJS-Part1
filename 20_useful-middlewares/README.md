# 20. Useful Middlewares

여기는 **Express 서버 마을**입니다.  
이 마을은 **웹사이트를 운영하는 아주 똑똑한 시스템**이며, 이곳에는 마을의 평화를 지키고 사용자 요청을 처리해주는 **전문가들(미들웨어)**이 살고 있습니다.

사용자들이 웹사이트를 이용할 때마다 다양한 요청을 보내오고, 이 요청들은 이 마을의 전문가들이 순서대로 점검하고 처리합니다.  
지금부터 Express 마을의 미들웨어 주민들을 하나씩 만나보겠습니다.

---

## 1️⃣ 바디파서(body-parser): 마을의 통역가입니다 ✍️

### 🧑‍🏫 누구인가요?

옛날 옛적, 서버 마을에는 외부에서 편지(요청)가 쏟아졌습니다.  
그런데 이 편지들은 매우 복잡하고 이해하기 힘든 형태였습니다.  
글자들이 뒤섞여 있어서 마을 사람들이 내용을 읽을 수 없었습니다.

그때 **바디파서 통역가**가 등장했습니다.

"걱정 마세요! 제가 이 복잡한 편지를 읽기 좋게 바꿔드리겠습니다!"

그 이후로 바디파서는 사용자들이 보낸 JSON이나 폼 데이터를 **알아보기 쉽게 정리해주는 역할**을 하게 되었습니다.

---

### 🧰 왜 필요할까요?

- 사용자가 로그인하거나 회원가입할 때, 입력한 아이디나 비밀번호 같은 데이터를 읽어야 하기 때문입니다.
- 서버는 기본적으로 이 데이터를 해석하지 못하므로, 바디파서가 통역 역할을 해줘야 합니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
app.use(express.json()); // JSON 데이터를 읽습니다.
app.use(express.urlencoded({ extended: true })); // 폼 데이터를 읽습니다.
```

---

## 2️⃣ 코스(cors): 국경 관리관입니다 🛂

### 🧑‍⚖️ 누구인가요?

Express 마을은 기본적으로 **자신의 마을에서 온 요청만 받습니다**.  
그런데 어느 날, 옆 마을 웹사이트(예: 프론트엔드)에서 요청이 들어왔습니다.  
Express 마을은 당황했습니다.

"이건 우리 마을 사람이 아니잖아? 이걸 받아도 되는 걸까?"

그때 등장한 사람이 **CORS 국경 관리관**입니다.

"걱정 마세요. 누가 안전하게 들어올 수 있는지 제가 판단하겠습니다."

CORS는 다른 도메인에서 들어온 요청이 **허용 가능한지 여부를 판단하고 허가**해주는 역할을 합니다.

---

### 🧰 왜 필요할까요?

- 프론트엔드와 백엔드가 서로 다른 서버에서 운영될 때, 요청을 허용해야 하기 때문입니다.
- 보안상 브라우저는 다른 출처의 요청을 막기 때문에 이를 명시적으로 풀어줘야 합니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
const cors = require("cors");
app.use(cors()); // 모든 출처 허용
```

- https://www.npmjs.com/package/cors

---

## 3️⃣ 헬멧(helmet): 보안 경비대장입니다 🛡️

### 🕵️ 누구인가요?

Express 마을에는 **해커 괴도**들이 몰래 들어와서 문제를 일으키곤 했습니다.  
어떤 해커는 쿠키를 훔쳐갔고, 어떤 해커는 이상한 코드를 몰래 삽입했습니다.

그때 **헬멧 대장**이 나타났습니다.

"걱정 마십시오! 제가 보안 장비를 착용시켜드리겠습니다!"

헬멧은 다양한 HTTP 보안 헤더를 자동으로 설정해 서버를 안전하게 지켜주는 역할을 합니다.

---

### 🧰 왜 필요할까요?

- 보안에 취약한 헤더들을 자동으로 설정하여, XSS나 클릭재킹 같은 공격을 막기 위함입니다.
- 특히 실무에서는 기본으로 설정하는 것이 좋습니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
const helmet = require("helmet");
app.use(helmet());
```

- https://www.npmjs.com/package/helmet

---

## 4️⃣ 모건(morgan): 마을 기록관입니다 📖

### 🧓 누구인가요?

**모건 아저씨**는 Express 마을의 모든 일을 기록하는 사람입니다.  
누가 언제 어떤 요청을 보냈는지, 얼마나 걸렸는지 등을 꼼꼼히 적어두는 일을 합니다.

“오전 9시 13분, 사용자 한 명이 ‘/login’을 요청했습니다… 기록 완료!”

이 기록들은 나중에 문제가 생겼을 때 빠르게 확인하는 데 유용합니다.

---

### 🧰 왜 필요할까요?

- 서버에 어떤 요청이 들어왔는지 실시간으로 확인할 수 있기 때문입니다.
- 개발 중에 요청 흐름을 추적하거나 에러 원인을 찾을 때 도움이 됩니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
const morgan = require("morgan");
app.use(morgan("dev"));
```

- https://www.npmjs.com/package/morgan

---

## 5️⃣ 컴프레션(compression): 택배 포장팀입니다 📦

### 📦 누구인가요?

Express 마을은 사용자에게 많은 데이터를 보내야 할 때가 있습니다.  
하지만 데이터가 너무 크면 전송 시간이 길어지고, 사용자는 답답해합니다.

그래서 **컴프레션 포장팀**이 등장합니다.

"걱정하지 마세요! 데이터를 작게 압축해서 보내드리겠습니다!"

이 미들웨어는 응답 데이터를 gzip으로 압축하여 더 빠르게 사용자에게 전송해줍니다.

---

### 🧰 왜 필요할까요?

- 대량의 텍스트, 이미지, JSON 데이터를 빠르게 전송하기 위해서입니다.
- 속도와 서버 효율성을 동시에 높일 수 있습니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
const compression = require("compression");
app.use(compression());
```

- https://www.npmjs.com/package/compression

---

## 6️⃣ 세션 관리자(express-session): 주민 등록소 관리자입니다 🗃️

### 🧑‍💼 누구인가요?

Express 마을에는 방문자가 늘어나자, **누가 누군지 기억할 수 있는 시스템**이 필요해졌습니다.  
"이 사람은 지난번에도 왔던 사람인가요?"

그때 **세션 관리자**가 등장했습니다.

“각 사람마다 고유한 세션 파일을 만들어 저장하겠습니다!”

세션 미들웨어는 사용자를 기억하고, 로그인 상태를 유지할 수 있도록 도와줍니다.

---

### 🧰 왜 필요할까요?

- 로그인 정보를 세션에 저장하여, 사용자가 다시 로그인하지 않아도 되게 하기 위함입니다.
- 사용자별 임시 데이터를 저장할 때도 사용됩니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
const session = require("express-session");
app.use(
  session({
    secret: "비밀열쇠",
    resave: false,
    saveUninitialized: true,
    cookie: { secure: false },
  })
);
```

- https://www.npmjs.com/package/express-session

---

## 7️⃣ 패스포트(passport): 신분 확인 보안요원입니다 👮

### 🕵️ 누구인가요?

패스포트는 마을 입구에서 사용자의 신분을 확인하는 보안요원입니다.  
"이름이 무엇입니까? 비밀번호는요? 신원이 확인되었습니다. 통과하세요."

**패스포트 요원**은 사용자가 입력한 로그인 정보를 확인하고, 맞으면 통과시켜줍니다.  
그리고 로그인 이후에는 계속 그 사용자가 누구인지 기억합니다.

---

### 🧰 왜 필요할까요?

- 로그인 기능을 구현할 때 필요합니다.
- 다양한 인증 방식(소셜 로그인, 토큰 등)을 쉽게 처리할 수 있습니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
const passport = require("passport");
const LocalStrategy = require("passport-local").Strategy;

passport.use(
  new LocalStrategy((username, password, done) => {
    if (username === "test" && password === "pass") {
      return done(null, { id: 1, username: "test" });
    }
    return done(null, false);
  })
);

passport.serializeUser((user, done) => done(null, user.id));
passport.deserializeUser((id, done) => {
  done(null, { id, username: "test" });
});
```

- https://www.npmjs.com/package/passport

---

## 8️⃣ 익스프레스 밸리데이터(express-validator): 깐깐한 검사관입니다 🔍

### 👩‍🏫 누구인가요?

밸리데이터 선생님은 사용자가 보낸 정보가 **정확한지 검사**합니다.  
"아이디는 너무 짧은데요?"  
"이건 이메일 형식이 아닙니다."

이처럼, 서버로 들어오기 전에 데이터를 꼼꼼하게 확인하여 **문제가 생기지 않도록 방지**합니다.

---

### 🧰 왜 필요할까요?

- 사용자 입력값이 올바른지 검사해야 서버가 오류 없이 동작하기 때문입니다.
- 잘못된 값이 들어오지 않도록 검증하고, 보안을 높일 수 있습니다.

---

### 🛠️ 실제 사용 예시입니다:

```js
const { body, validationResult } = require("express-validator");

app.post(
  "/register",
  [
    body("username")
      .isLength({ min: 5 })
      .withMessage("아이디는 최소 5글자 이상이어야 합니다."),
    body("email").isEmail().withMessage("올바른 이메일 주소를 입력해 주세요."),
    body("password")
      .isLength({ min: 8 })
      .withMessage("비밀번호는 최소 8글자 이상이어야 합니다."),
  ],
  (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    res.send("회원가입 요청이 성공적으로 처리되었습니다.");
  }
);
```

- https://www.npmjs.com/package/express-validator

---

## 🎉 마무리 – Express 마을을 지키는 8명의 전문가들입니다

- ✍️ `body-parser`: 데이터를 읽어주는 통역가입니다.
- 🛂 `cors`: 외부 요청을 허락해주는 국경 관리자입니다.
- 🛡️ `helmet`: 서버를 보호하는 보안 장치 전문가입니다.
- 📖 `morgan`: 요청을 기록하는 기록 관리자입니다.
- 📦 `compression`: 데이터를 작게 포장하는 압축 전문가입니다.
- 🗃️ `express-session`: 방문자를 기억해주는 세션 관리자입니다.
- 👮 `passport`: 사용자의 신원을 확인하는 인증 보안요원입니다.
- 🔍 `express-validator`: 사용자 입력값을 검사하는 데이터 검사관입니다.

이 미들웨어들이 함께하면 Express 서버는 **안전하고, 빠르고, 똑똑하게 작동**합니다.  
여러분도 이 마을의 주민들을 잘 활용해서 멋진 서버를 만들어보시기 바랍니다. 😊
