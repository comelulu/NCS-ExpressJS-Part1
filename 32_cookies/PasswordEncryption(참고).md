# 🔐 비밀번호 암호화와 세션 연동 – Express에서 안전한 로그인 시스템 구현

---

## 📦 비밀번호 암호화란?

### 💡 **비밀번호 암호화**란 사용자의 비밀번호를 **서버에 안전하게 저장**하는 방법입니다.  
현실 세계에서 중요한 **정보**를 안전하게 보관하는 방법을 생각해 보면, **비밀번호**는 마치 **열쇠**와 같습니다. 그런데 **열쇠를 아무 곳에나 두면** **누군가**가 쉽게 **열쇠를 찾아서** 문을 열 수 있겠죠? 그래서 **열쇠를 안전하게 숨겨두는 방법**이 필요합니다. 바로 **암호화**가 그 방법입니다.

- **암호화**는 비밀번호를 **원래의 값**이 아닌 **변형된 값**으로 바꿔 저장하는 과정입니다. **변형된 값**은 **복원할 수 없도록 만들어**서 보안에 강력하게 보호할 수 있습니다.

---

## 🧠 왜 비밀번호를 암호화해야 할까요?

- **보안성 강화**: 비밀번호를 **평문으로 저장**하면, **해킹**을 당했을 때 **누군가**가 쉽게 그 비밀번호를 **알 수 있습니다**. 하지만 암호화하면, **비밀번호를 아무리 훔쳐도 복호화(원래 값으로 되돌리기)할 수 없습니다**.

- **사용자 보호**: **비밀번호를 평문으로 저장**하면, **서버가 해킹당했을 때** **모든 사용자의 비밀번호가 유출**될 수 있습니다. 암호화된 **비밀번호는 복호화가 불가능**해서, 유출되더라도 실제 비밀번호를 알 수 없습니다.

**암호화**를 통해 **누군가**가 **비밀번호를 탈취**해도 그 **비밀번호를 쉽게 복원**할 수 없도록 보호할 수 있습니다.

---

## 🔍 암호화 개념 – 현실 세계 비유

### 💡 **Salt**와 **Hash(해시)**

1. **Salt(소금)**  
   **Salt**는 마치 **소금**을 **음식**에 넣는 것처럼 생각할 수 있습니다. **소금**은 **음식**의 **맛을 바꾸기** 때문에, **같은 음식**이라도 **소금**을 넣으면 **맛이 달라집니다**.  
   
   **Salt**는 비밀번호에 **소금처럼 추가되는 값**으로, 같은 비밀번호라 하더라도 **Salt**를 넣으면 **다르게 변환**됩니다. **소금을 넣는 이유**는 **단순히** 같은 비밀번호라도 **결과가 같지 않게** 만들기 위함입니다. 이렇게 하면 **해커**가 여러 **비밀번호 해시값**을 비교하는 방법으로 **원래의 비밀번호**를 알아내는 것을 막을 수 있습니다.

   - **현실 세계 비유**: 두 사람이 **같은 음식을 만들었지만** 소금의 양이 다르면 **완전히 다른 음식**이 되듯, **Salt**를 추가하면 **같은 비밀번호도 서로 다른 해시값**을 만들어 냅니다.

2. **Hash(해시)**  
   **Hash**는 마치 **음식을 완전히 갈아서 새로운 형태로 만드는** 과정입니다. 음식의 **재료**를 **갈아서 섞은 후**, 원래의 **모양을 알아낼 수 없도록** 만드는 것입니다.  
   
   **Hash**는 **비밀번호를 특정 알고리즘**을 통해 **고유한 문자열**로 변환하여 **복원할 수 없도록 만듭니다**. **즉, 비밀번호는 해시값으로 변환되고**, 그 **해시값**은 다시 **원래 비밀번호로 되돌릴 수 없습니다**.

   - **현실 세계 비유**: **갈아서** 만든 **음식**은 원래의 **재료**로 다시 되돌릴 수 없듯, **Hash**는 비밀번호를 **변형**하여 **되돌릴 수 없는 고유한 값**을 만듭니다.

### 💡 **대칭키와 비대칭키**

1. **대칭키(대칭 암호화)**  
   **대칭키**는 **하나의 열쇠**로 **문을 열고 닫는 방식**입니다. 이 방식은 **암호화**와 **복호화**에 **같은 열쇠**를 사용합니다. 그래서 **열쇠를 잃어버리면 큰 문제가 생깁니다**.

   - **현실 세계 비유**: **한 개의 열쇠**로 **문을 잠그고 열 수 있는 방식**입니다. 이 방식에서는 **누군가**가 **열쇠를 훔쳐가면 문을 열 수** 있습니다.

2. **비대칭키(비대칭 암호화)**  
   **비대칭키**는 **두 개의 열쇠**를 사용합니다. 하나는 **공개키**(누구나 알 수 있는 열쇠)이고, 다른 하나는 **비공개키**(자기만 아는 열쇠)입니다. **공개키**로 **암호화**한 메시지는 **비공개키**로만 **복호화**할 수 있습니다.

   - **현실 세계 비유**: **편지를 잠글 수 있는 열쇠**는 **모두가** 사용할 수 있지만, 그 **편지를 열 수 있는 열쇠**는 **자기만** 가지고 있어야 하는 방식입니다.

### 💡 **단방향 암호화와 복호화**

1. **단방향 암호화**  
   **단방향 암호화**는 **복원할 수 없는 방식**입니다. 한 번 **암호화**된 비밀번호는 **다시 원래대로 되돌릴 수 없습니다**. 이것은 마치 **강물을 위에서 아래로 흘려보내는 것**과 같습니다.

   - **현실 세계 비유**: **흘러간 물**은 **다시 되돌릴 수 없듯이**, **단방향 암호화**는 **한 번 암호화하면** 원래의 비밀번호를 **복원할 수 없습니다**.

2. **복호화**  
   **복호화**는 **암호화된 데이터**를 **원래의 값**으로 되돌리는 과정입니다. 하지만 **단방향 암호화**는 **복호화가 불가능**합니다. 대신, 비밀번호를 **비교**할 때는 **암호화된 값**과 **입력한 값을 비교**합니다.

   - **현실 세계 비유**: **복호화**는 **돌아온 물**을 다시 **원래의 상태로 되돌려 마시는 것**처럼, **복호화가 불가능**한 **단방향 암호화**에서는 **그 물을 되돌릴 수 없습니다**.

---

## 🛠️ 비밀번호 암호화와 세션 연동 구현

이제 **비밀번호 암호화**와 **세션 연동**을 실제로 어떻게 구현할 수 있는지 살펴보겠습니다. Express에서는 **`bcrypt`** 라이브러리로 **비밀번호 암호화**를 쉽게 처리하고, **세션**을 사용해 로그인 상태를 유지할 수 있습니다.

---

## 📦 실습 구조 예시

```js
📦 express-login-session-hash-demo
 ┣ 📄 app.js                 ← 비밀번호 암호화 및 세션 예제
 ┣ 📄 package.json           ← bcrypt, express-session 포함
```

---

## 1️⃣ 설치하기

```bash
npm install express-session bcrypt
```

---

## 2️⃣ 📄 app.js – 비밀번호 암호화 및 세션 연동 예제

```js
const express = require("express");
const session = require("express-session");
const bcrypt = require("bcrypt");

const app = express();

// POST 요청 처리를 위한 body-parser 내장 미들웨어
app.use(express.urlencoded({ extended: true }));

// 가상의 데이터베이스 (사용자 정보 저장)
const usersDB = [];

/* -------------------------------------------------------------------
  [1] 세션 미들웨어 설정
------------------------------------------------------------------- */
app.use(
  session({
    secret: "secret-key-1234",  // 🔐 세션 암호화용 키
    resave: false,              // 매 요청마다 세션을 저장할지 여부
    saveUninitialized: true,   // 로그인 하지 않아도 세션 생성할지 여부
    cookie: {
      httpOnly: true,          // JS에서 접근 불가 (보안)
      maxAge: 1000 * 60 * 10,  // 세션 유지 시간: 10분
    },
  })
);

/* -------------------------------------------------------------------
  [2] 회원가입 폼 (GET 요청)
------------------------------------------------------------------- */
app.get("/signup", (req, res) => {
  res.send(`
    <form method="POST" action="/signup">
      <input name="username" placeholder="아이디 입력" />
      <input type="password" name="password" placeholder="비밀번호 입력" />
      <button type="submit">회원가입</button>
    </form>
  `);
});

/* -------------------------------------------------------------------
  [3] 회원가입 처리 (POST 요청)
  비밀번호 암호화 후 데이터베이스에 저장
------------------------------------------------------------------- */
app.post("/signup", async (req, res) => {
  const { username, password } = req.body;

  // 비밀번호 암호화
  const hashedPassword = await bcrypt.hash(password, 10);  // saltRounds = 10

  // 가상의 데이터베이스에 사용자 정보 저장
  usersDB.push({ username, password: hashedPassword });

  res.send(`✅ 회원가입 성공! <a href="/login">로그인</a>`);
});

/* -------------------------------------------------------------------
  [4] 로그인 폼 (GET 요청)
------------------------------------------------------------------- */
app.get("/login", (req, res) => {
  res.send(`
    <form method="POST" action="/login">
      <input name="username" placeholder="아이디 입력" />
      <input type="password" name="password" placeholder="비밀번호 입력" />
      <button type="submit">로그인</button>
    </form>
  `);
});

/* -------------------------------------------------------------------
  [5] 로그인 처리 (POST 요청)
  암호화된 비밀번호와 비교 후 로그인 처리
------------------------------------------------------------------- */
app.post("/login", async (req, res) => {
  const { username, password } = req.body;

  // 데이터베이스에서 사용자 찾기
  const user = usersDB.find((u) => u.username === username);

  if (user) {
    // 비밀번호 비교
    const match = await bcrypt.compare(password, user.password);

    if (match) {
      // 비밀번호 일치 → 세션에 사용자 정보 저장
      req.session.user = username;
      res.send(`✅ 로그인 성공! <a href="/profile">프로필 보기</a>`);
    } else {
      res.send("❌ 비밀번호가 틀렸습니다. <a href='/login'>다시 시도</a>");
    }
  } else {
    res.send("❌ 아이디가 존재하지 않습니다. <a href='/login'>다시 시도</a>");
  }
});

/* -------------------------------------------------------------------
  [6] 사용자 상태 확인 (세션 확인)
------------------------------------------------------------------- */
app.get("/profile", (req, res) => {
  if (req.session.user) {
    res.send(`🙋 ${req.session.user}님, 환영합니다! <a href="/logout">로그아웃</a>`);
  } else {
    res.send("❌ 로그인되지 않았습니다. <a href='/login'>로그인</a>");
  }
});

/* -------------------------------------------------------------------
  [7] 로그아웃 처리 – 세션 제거
------------------------------------------------------------------- */
app.get("/logout", (req, res) => {
  req.session.destroy(() => {
    res.send("👋 로그아웃 되었습니다. <a href='/login'>다시 로그인</a>");
  });
});

// 서버 실행
app.listen(3000, () => {
  console.log("🔐 Session & Hash Login demo server running at http://localhost:3000");
});
```

---

## 📊 비밀번호 암호화와 세션 연동 흐름 요약 시각화

```js
[1] GET /signup
────────────────────────
HTML 폼 응답

[2] POST /signup
────────────────────────
- req.body.username, req.body.password 추출
- bcrypt.hash(password)로 비밀번호 암호화
- 사용자 정보 가상의 DB(usersDB) 저장

[3] GET /login
────────────────────────
HTML 로그인 폼 응답

[4] POST /login
────────────────────────
- req.body.username, req.body.password 추출
- 데이터베이스에서 사용자 찾기
- bcrypt.compare(password, hashedPassword)로 비밀번호 비교
- 비밀번호 일치 → 세션에 사용자 정보 저장

[5] GET /profile
────────────────────────
- 쿠키에 저장된 세션ID → 서버가 세션 정보 조회
- 사용자 인식 성공 → 환영 메시지 응답

[6] GET /logout
────────────────────────
- 세션 삭제 → connect.sid 무효화
```

---

## 🧪 실제 세션 요청 확인 (브라우저 개발자 도구)

```http
GET /profile HTTP/1.1
Host: localhost:3000
Cookie: connect.sid=s%3A4FuY...zJm.Q7dN...
```

> `connect.sid=...` 쿠키가 전송되고, 서버는 세션 ID를 이용해 해당 사용자의 상태를 조회하여 로그인 상태를 확인합니다.

---

## 🔐 보안 팁 – 비밀번호 암호화와 세션 연동 시 안전하게 구현하기

| 설정 | 설명 | 추천 여부 |
|------|------|-----------|
| `bcrypt.hash()` | 비밀번호를 안전하게 암호화하는 함수. | ✅ 반드시 사용 |
| `bcrypt.compare()` | 로그인 시 입력한 비밀번호와 저장된 해시비밀번호 비교. | ✅ 항상 사용 |
| `secret` | 세션 데이터의 서명(암호화)을 위한 키. 절대 깃헙에 올리지 마세요. | ✅ 항상 사용 |
| `httpOnly` | JavaScript에서 쿠키 접근 차단. XSS 공격 방지용 필수. | ✅ 항상 true |
| `secure` | HTTPS에서만 쿠키 전송 (배포 시 필수). | ✅ 운영 환경에서 필수 |
| `sameSite` | 다른 사이트에서 자동 요청 차단 (CSRF 방지) | ✅ `Lax` 또는 `Strict` 권장 |
| `maxAge` | 세션 만료 시간 설정 (짧게 유지할수록 보안상 유리). | ✅ 필수 사용 |

---

## ✅ Express에서 비밀번호 암호화와 세션 관련 메서드 정리

| 속성/메서드 | 설명 | 예시 |
|-------------|------|------|
| `bcrypt.hash(password, saltRounds)` | 비밀번호 암호화 | `bcrypt.hash("password123", 10)` |
| `bcrypt.compare(password, hash)` | 비밀번호 비교 | `bcrypt.compare("password123", hash)` |
| `req.session` | 세션 저장소 | `req.session.user = "Tom"` |
| `req.session.destroy()` | 세션 제거 | 로그아웃 시 사용 |

---

## 🔚 마무리 요약

| 개념 | 설명 |
|------|------|
| 비밀번호 암호화 | bcrypt를 사용하여 비밀번호를 안전하게 암호화 |
| 비밀번호 비교 | 로그인 시 암호화된 비밀번호와 입력한 비밀번호를 비교 |
| 세션 연동 | 로그인 성공 시 세션에 사용자 정보를 저장하고, 로그인 상태를 유지 |
| 보안 관리 | `bcrypt`로 비밀번호 보호, `express-session`으로 로그인 상태 보호 |

