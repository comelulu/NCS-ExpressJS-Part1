# 🔐 세션을 활용한 로그인 시스템 구현 – Express에서 세션을 이용한 로그인

---

## 📦 세션을 활용한 로그인 시스템

세션을 활용하여 **사용자의 로그인 상태를 유지**하고, **로그인 인증**을 쉽게 처리할 수 있습니다.  
앞서 배운 세션을 활용하여, 로그인 및 로그아웃 흐름을 어떻게 구현할 수 있는지 확인해 봅시다.

---

## 🧠 로그인 시스템 구현하기

**로그인 시스템의 흐름은 다음과 같습니다:**

1. 사용자가 로그인 폼을 제출합니다.
2. 서버는 사용자가 입력한 정보를 검증합니다.
3. 검증이 성공하면, 세션에 사용자 정보를 저장하고 로그인 상태를 유지합니다.
4. 사용자가 프로필 페이지를 요청할 때, 서버는 세션에 저장된 사용자 정보를 바탕으로 해당 사용자의 프로필을 보여줍니다.
5. 사용자가 로그아웃하면, 세션을 삭제하고 로그인 상태를 해제합니다.

---

## 🔍 세션을 이용한 로그인 시스템 – 핵심 흐름

### 💡 로그인 시

1. **사용자**가 로그인 폼을 통해 로그인 요청
2. **서버**는 사용자 이름과 비밀번호를 확인 후 세션에 사용자 정보를 저장
3. **브라우저**는 `connect.sid` 쿠키를 자동으로 포함해 요청을 보냄
4. **서버**는 쿠키에 담긴 세션 ID를 통해 사용자 정보를 조회하고 로그인 상태를 유지

### 💡 로그아웃 시

1. **사용자**가 로그아웃 버튼 클릭
2. **서버**는 세션을 삭제하고 `connect.sid` 쿠키를 무효화
3. **브라우저**는 더 이상 유효한 세션 ID가 없으므로 로그인 상태가 해제됨

---

## 🍪 세션과 로그인 상태 유지 – 핵심 비교

| 항목 | 세션 (Session) | 로그인 (Login) |
|------|----------------|----------------|
| 상태 저장 | 서버 | 클라이언트(세션에 저장된 사용자 정보) |
| 세션 ID | `connect.sid` 쿠키로 브라우저와 서버 간 전달 | 로그인 후 세션에 사용자 정보 저장 |
| 상태 유지 | 서버에서 상태를 계속 추적 | 로그인 상태에 따라 서버가 사용자 정보를 반환 |

---

## 🛠️ 세션을 활용한 로그인 시스템 구현하기

Express에서는 **`express-session`** 미들웨어를 사용하여 세션을 아주 쉽게 관리할 수 있습니다. 이번 실습에서는 사용자가 로그인할 때 세션에 사용자 정보를 저장하고, 로그인 상태를 유지하는 방법을 다룹니다.

---

## 📦 실습 구조 예시

```js
📦 express-login-session-demo
 ┣ 📄 app.js                 ← 로그인 시스템 예제
 ┣ 📄 package.json           ← express-session 포함
```

---

## 1️⃣ 설치하기

```bash
npm install express-session
```

---

## 2️⃣ 📄 app.js – 세션 기반 로그인 시스템 예제

```js
const express = require("express");
const session = require("express-session");

const app = express();

// POST 요청 처리를 위한 body-parser 내장 미들웨어
app.use(express.urlencoded({ extended: true }));

/* -------------------------------------------------------------------
  [1] 세션 미들웨어 설정
------------------------------------------------------------------- */
app.use(
  session({
    secret: "secret-key-1234",  // 🔐 세션 암호화용 키 (절대 공개 X)
    resave: false,              // 매 요청마다 세션을 저장할지 여부
    saveUninitialized: true,   // 로그인 하지 않아도 세션 생성할지 여부
    cookie: {
      httpOnly: true,          // JS에서 접근 불가 (보안)
      maxAge: 1000 * 60 * 10,  // 세션 유지 시간: 10분
    },
  })
);

/* -------------------------------------------------------------------
  [2] 로그인 폼 (GET 요청)
------------------------------------------------------------------- */
app.get("/login", (req, res) => {
  res.send(`
    <form method="POST" action="/login">
      <input name="username" placeholder="이름 입력" />
      <button type="submit">로그인</button>
    </form>
  `);
});

/* -------------------------------------------------------------------
  [3] 로그인 처리 (POST 요청)
  로그인하면 세션에 사용자 정보 저장
------------------------------------------------------------------- */
app.post("/login", (req, res) => {
  const username = req.body.username;

  // 사용자의 이름을 세션에 저장
  req.session.user = username;

  res.send(`✅ 로그인 성공! <a href="/profile">프로필 보기</a>`);
});

/* -------------------------------------------------------------------
  [4] 사용자 상태 확인 (세션 확인)
------------------------------------------------------------------- */
app.get("/profile", (req, res) => {
  if (req.session.user) {
    res.send(`🙋 ${req.session.user}님, 환영합니다! <a href="/logout">로그아웃</a>`);
  } else {
    res.send("❌ 로그인되지 않았습니다. <a href='/login'>로그인</a>");
  }
});

/* -------------------------------------------------------------------
  [5] 로그아웃 처리 – 세션 제거
------------------------------------------------------------------- */
app.get("/logout", (req, res) => {
  req.session.destroy(() => {
    res.send("👋 로그아웃 되었습니다. <a href='/login'>다시 로그인</a>");
  });
});

// 서버 실행
app.listen(3000, () => {
  console.log("🔐 Session Login demo server running at http://localhost:3000");
});
```

---

## 📊 로그인 시스템 흐름 요약 시각화

```js
[1] GET /login
────────────────────────
HTML 폼 응답

[2] POST /login
────────────────────────
- req.body.username 추출
- req.session.user = username 저장
- connect.sid 쿠키 생성됨

[3] GET /profile
────────────────────────
- 쿠키에 저장된 세션ID → 서버가 세션 정보 조회
- 사용자 인식 성공 → 환영 메시지 응답

[4] GET /logout
────────────────────────
- 세션 삭제 → connect.sid 무효화
```

---

## 🧪 실제 세션 요청 확인 (브라우저 개발자 도구)

```http
GET /profile HTTP/1.1
Host: localhost:3000
Cookie: connect.sid=s%3A4FuY...zJm.Q7dN...
```

> 이처럼 `connect.sid=...`가 쿠키로 전송되고,  
> 서버는 세션 ID를 이용해 해당 사용자의 상태를 조회합니다.

---

## 🔐 보안 팁 – 로그인 시스템을 안전하게 구현하기

| 설정 | 설명 | 추천 여부 |
|------|------|-----------|
| `secret` | 세션 데이터의 서명(암호화)을 위한 키. 절대 깃헙에 올리지 마세요. | ✅ 항상 사용 |
| `httpOnly` | JavaScript에서 쿠키 접근 차단. XSS 공격 방지용 필수. | ✅ 항상 true |
| `secure` | HTTPS에서만 쿠키 전송 (배포 시 필수). | ✅ 운영 환경에서 필수 |
| `sameSite` | 다른 사이트에서 자동 요청 차단 (CSRF 방지) | ✅ `Lax` 또는 `Strict` 권장 |
| `maxAge` | 세션 만료 시간 설정 (짧게 유지할수록 보안상 유리). | ✅ 필수 사용 |

---

## ✅ Express에서 세션 관련 메서드 정리

| 속성/메서드 | 설명 | 예시 |
|-------------|------|------|
| `req.session` | 세션 저장소 | `req.session.user = "Tom"` |
| `req.session.user` | 사용자 정보 저장/조회 | 로그인 여부 확인에 사용 |
| `req.session.destroy()` | 세션 제거 | 로그아웃 시 사용 |

---

## 🔚 마무리 요약

| 개념 | 설명 |
|------|------|
| 세션이란? | 서버가 사용자의 상태를 기억하는 저장소 |
| 동작 방식 | 서버에 사용자 상태 저장 + 브라우저는 ID만 쿠키로 전송 |
| 세션 ID | `connect.sid` 쿠키로 사용자와 서버 간의 연결 |
| Express 구현 | `express-session`으로 세션 쉽게 관리 |
| 보안 관리 | `secret`, `httpOnly`, `secure`, `maxAge` 등 필수 설정 필요 |

