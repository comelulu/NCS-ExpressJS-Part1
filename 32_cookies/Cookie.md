# 32. 🍪 쿠키(Cookie)로 사용자 상태 저장하기 – 브라우저와 서버의 연결 메모장

---

## 🧠 쿠키란? (비유부터 시작)

💬 쿠키는 웹 개발에서 쓰이는 **작고 간단한 메모장**입니다.  
서버가 클라이언트(브라우저)에 **"얘가 누군지, 뭘 했는지"**를 적어서 보냅니다.  
그러면 브라우저는 그걸 기억해뒀다가 **다음 요청 때 다시 보여줍니다.**

### 📦 쿠키 = 클라이언트 쪽 기억장치
- 브라우저가 서버로부터 받은 쿠키를 저장해둡니다.
- 다음에 같은 사이트를 방문하면 **자동으로 서버에 다시 보내줍니다.**
- 쿠키가 없으면 서버는 매번 **"너 누구냐?"** 물어봐야 합니다.

---

## 🔍 쿠키의 실체: 실제 HTTP 요청 헤더에 담긴 모습

다음은 브라우저가 쿠키를 포함해 서버에 요청을 보낼 때의 실제 HTTP 메시지입니다:

```
GET /get-cookie HTTP/1.1
Host: localhost:3000
Cookie: name=John%20Doe
User-Agent: Chrome/122.0
```

> ✅ `Cookie: name=John%20Doe`  
> 브라우저가 이전에 받은 `name=John Doe` 쿠키를 **자동으로 전송**하고 있는 모습이에요.

---

## ❓ 왜 쿠키가 필요할까?

웹의 기본 통신 방식인 **HTTP**는 **"기억을 못하는" 구조**입니다.  
서버는 한 번 요청을 처리하고 나면 **"이게 누가 보낸 건지"** 바로 잊어버립니다.

### 🎯 예를 들어보면:
- 사용자가 로그인했다 해도,
- 다음 요청에서 서버는 "얘가 로그인 한 사람인지?" 모름
- 계속 새로 로그인해야 함... 😵

➡ 그래서 **사용자의 상태**를 유지하기 위한 방법이 필요합니다.  
그게 바로 **쿠키**입니다.

---

## 🍪 쿠키 작동 방식 시각화

```
🧍 사용자: 처음으로 /set-cookie 요청
────────────────────────────────────
↓
📦 서버:
  - name=John 이라는 쿠키 생성
  - 브라우저에 응답에 실어 보냄
↓
🌐 브라우저:
  - 쿠키 저장: name=John

🧍 다음에 /get-cookie 요청할 때
────────────────────────────────────
↓
🌐 브라우저:
  - 저장된 name=John 쿠키를 자동으로 서버에 함께 전송
↓
📦 서버:
  - 쿠키 확인 후 "아~ John이구나!" 라고 사용자 인식
```

---

## 📘 정리: 쿠키는 어디에 저장되고, 언제 보내질까?

| 항목 | 설명 |
|------|------|
| 저장 위치 | 브라우저의 로컬 저장소 (도메인별로 저장됨) |
| 전송 시점 | 같은 사이트에 다시 요청할 때 자동 포함 |
| 헤더 형태 | `Cookie: name=value; userId=123; token=abcd` |

브라우저에서는 개발자 도구(F12) → Application → Cookies 탭에서  
쿠키를 직접 보고 편집하거나 삭제할 수 있어요.

---

## 🛠️ Express에서 쿠키 다루기

Node.js 기반의 Express에서는 쿠키를 쉽게 다루기 위해  
**`cookie-parser` 미들웨어**를 사용합니다.

---

## 📦 실습 구조 예시

```
📦 express-cookie-demo
 ┣ 📄 app.js              ← 쿠키 실습 전체 예제 코드
 ┣ 📄 package.json        ← cookie-parser 포함
```

---

## 1️⃣ 📄 app.js – 쿠키 실습 예제

```js
// 필요한 모듈 불러오기
const express = require("express");              // Express 서버 프레임워크
const cookieParser = require("cookie-parser");  // 쿠키 파서 미들웨어

const app = express();                           // 앱 생성

// 1. cookie-parser 미들웨어 적용
// → 요청(req)에 들어온 쿠키를 자동으로 읽어 req.cookies 객체에 넣어줍니다.
app.use(cookieParser());

/* -------------------------------------------------------------------
  [1] 쿠키 설정 – res.cookie("이름", "값", 옵션)
  → 서버가 클라이언트(브라우저)에 쿠키를 보내 저장시킴
------------------------------------------------------------------- */
app.get("/set-cookie", (req, res) => {
  res.cookie("name", "John Doe", {
    maxAge: 900000,       // 쿠키의 만료 시간 (15분)
    httpOnly: true,       // JS 코드에서 접근 불가 (XSS 보안)
    secure: false,        // HTTPS에서만 전송 (개발 시 false로 둠)
    sameSite: "Lax",      // CSRF 방지: 타사이트 폼에서 쿠키 제한
  });
  res.send("✅ 쿠키가 설정되었습니다 (name=John Doe)");
});

/* -------------------------------------------------------------------
  [2] 쿠키 확인 – req.cookies
  → 클라이언트가 보낸 쿠키를 읽을 수 있음
------------------------------------------------------------------- */
app.get("/get-cookie", (req, res) => {
  const userName = req.cookies.name;  // "name" 쿠키 가져오기
  if (userName) {
    res.send(`🙋 사용자 이름은 ${userName} 입니다.`);
  } else {
    res.send("❌ 쿠키가 존재하지 않습니다.");
  }
});

/* -------------------------------------------------------------------
  [3] 쿠키 삭제 – res.clearCookie("이름")
  → 브라우저에 저장된 쿠키를 제거 요청
------------------------------------------------------------------- */
app.get("/clear-cookie", (req, res) => {
  res.clearCookie("name");  // name 쿠키 제거
  res.send("🧹 name 쿠키가 삭제되었습니다.");
});

// 서버 실행
app.listen(3000, () => {
  console.log("🍪 Cookie demo server running at http://localhost:3000");
});
```

---

## 📊 요청 흐름 시각화 요약

```
[1] GET /set-cookie 요청
───────────────────────────────
서버:
  - name=John Doe 쿠키 생성
  - 브라우저에 전달
브라우저:
  - 쿠키 저장

[2] GET /get-cookie 요청
───────────────────────────────
브라우저:
  - 자동으로 쿠키(name=John Doe) 함께 전송
서버:
  - 쿠키 확인 후 사용자 인식

[3] GET /clear-cookie 요청
───────────────────────────────
서버:
  - name 쿠키 제거 명령
브라우저:
  - 쿠키 삭제됨
```

---

## 🧪 실제 쿠키 요청 확인 (브라우저 개발자 도구)

```http
GET /get-cookie HTTP/1.1
Host: localhost:3000
Cookie: name=John%20Doe
```

> 이처럼 `Cookie:` 헤더에 우리가 저장했던 쿠키가 자동으로 포함되어 전송됩니다.

---

## 🔐 보안 팁 – 안전한 쿠키 사용을 위한 설정

| 옵션 | 설명 | 추천 여부 |
|------|------|-----------|
| `httpOnly` | JavaScript에서 쿠키 접근 차단 | ✅ 항상 true |
| `secure` | HTTPS 연결에서만 쿠키 전송 | ✅ 운영환경에서 필수 |
| `sameSite` | 다른 사이트에서 자동 요청 차단 (CSRF 방지) | ✅ `Lax` 또는 `Strict` 권장 |
| `maxAge` / `expires` | 쿠키 만료 시간 설정 | ✅ 필수 사용 |

---

## ✅ Express에서 쿠키 관련 메서드 정리

| 메서드 | 설명 | 예시 |
|--------|------|------|
| `res.cookie(name, value, options)` | 쿠키 생성 | `res.cookie("name", "John", { maxAge: 1000 })` |
| `req.cookies` | 요청 쿠키 확인 | `req.cookies.name` |
| `res.clearCookie(name)` | 쿠키 삭제 | `res.clearCookie("name")` |

---

## 🔚 마무리 요약

| 개념 | 설명 |
|------|------|
| 쿠키란? | 브라우저에 저장되는 작은 정보 메모장 |
| 필요 이유 | 로그인 유지, 사용자 기억, 상태 유지 등 |
| 작동 방식 | 서버가 설정 → 브라우저 저장 → 재요청 시 자동 전송 |
| Express 사용 | cookie-parser로 쉽게 설정/읽기/삭제 가능 |
| 보안 설정 | httpOnly, secure, sameSite로 안전하게 사용 |
