# 36. 🔐 500 에러 대응 Part2 – 실전 예외 처리 설계

---

## 📦 500 에러 실전 예외 처리 설계란?

### 💡 **실전 예외 처리 설계**는 **서버 애플리케이션**에서 발생할 수 있는 다양한 오류를 **효율적으로 처리**하고, **사용자에게 적절한 메시지**를 제공하며, **디버깅을 용이하게** 만드는 중요한 부분입니다.  
이 과정에서 **에러 처리 미들웨어**를 활용하여, **특정 오류에 대해 세분화된 처리를 할 수 있습니다**.

---

## 🧠 실전 예외 처리 설계 이유

- **오류의 세분화 처리**: 모든 오류를 하나의 처리 미들웨어에서 처리하는 것이 아니라, **오류 종류에 맞게 적절한 미들웨어**를 활용하여 세분화하여 처리합니다.
- **유연한 에러 처리**: 오류의 **상황별 분리 처리**가 가능하고, **일반적인 오류 처리**를 위한 기본 미들웨어도 함께 사용할 수 있습니다.
- **에러 로그 관리**: 오류의 원인과 위치를 **세밀하게 추적**할 수 있게 하여 문제 해결 속도를 높일 수 있습니다.

---

## 🔍 코드 설명

### **케이스 1: 기본적인 오류 처리 미들웨어 1개 사용**

### 설명:
이 케이스는 **여러 라우트**에서 발생한 오류를 **하나의 오류 처리 미들웨어**로 처리하는 방법입니다. 즉, 모든 라우트에서 발생한 오류를 **단일 오류 처리 미들웨어**에서 처리합니다.

#### 동작 흐름:
1. 사용자가 **`/`** 경로로 접근하면 오류가 발생합니다.
2. 이 오류는 `throw new Error("/")`를 통해 강제로 발생하며, **Express**는 이 오류를 **오류 처리 미들웨어로 전달**합니다.
3. 이후 **`app.use((err, req, res, next)`**에서 해당 오류를 처리하고, **500 상태 코드**와 함께 에러 메시지를 클라이언트에 전달합니다.

```js
const express = require("express");
const app = express();

// 첫 번째 라우트와 오류 처리
app.get("/", (req, res) => {
  // '/' 경로에서 오류를 강제로 발생시킵니다.
  throw new Error("/"); // 오류가 발생하면, Express는 자동으로 오류 처리 미들웨어로 이동합니다.
});

// 오류 처리 미들웨어
// '/' 경로에서 발생한 오류를 처리하는 미들웨어입니다.
app.use((err, req, res, next) => {
  // 오류를 로그로 출력합니다. (일반적인 오류)
  console.error("General error:", err);
  // 500 상태 코드와 함께 사용자에게 에러 메시지를 전달합니다.
  res.status(500).send("[GET /] - Internal Server Error");
});

// 두 번째 라우트와 오류 처리
app.get("/users", (req, res) => {
  // '/users' 경로에서 오류를 강제로 발생시킵니다.
  throw new Error("/users"); // 오류가 발생하면, 해당 라우트에 대한 오류 처리 미들웨어로 넘어갑니다.
});

// 오류 처리 미들웨어
// '/users' 경로에서 발생한 오류를 처리하는 미들웨어입니다.
app.use((err, req, res, next) => {
  // 오류를 로그로 출력합니다. (일반적인 오류)
  console.error("General error:", err);
  // 500 상태 코드와 함께 사용자에게 에러 메시지를 전달합니다.
  res.status(500).send("[GET /users] - Internal Server Error");
});

// 서버 실행
app.listen(3000, () => {
  console.log("Server running on port 3000");
});
```

#### **설명**:
- **`throw new Error("/");`**: 이 코드는 **동기적으로** 오류를 발생시키고, 발생한 오류는 **Express의 오류 처리 미들웨어로 자동 전달**됩니다.
- **`app.use((err, req, res, next)`**: 이 부분에서 오류를 **캐치하고 처리**합니다. 오류 메시지와 함께 **500 상태 코드**를 반환하며, 사용자에게 서버 내부 오류가 발생했다는 메시지를 표시합니다.
- **`app.use((err, req, res, next)`**: 두 번째 라우트(`/users`)에서도 동일한 방식으로 오류를 처리합니다.

---

### **케이스 2: 오류 처리 미들웨어가 여러 개인 경우**

### 설명:
이 케이스는 **오류의 유형**에 따라 **다른 미들웨어**에서 각각 처리하는 방법입니다. 예를 들어, **데이터베이스 오류**와 **일반적인 오류**를 구분하여 처리하는 방식입니다.

#### 동작 흐름:
1. 사용자가 **특정 라우트**에 접근하고 오류가 발생하면, 오류의 **유형**에 따라 처리 미들웨어가 달라집니다.
2. **`err.type`** 값에 따라, 첫 번째 미들웨어는 **데이터베이스 오류**를 처리하고, 그 외의 오류는 두 번째 미들웨어에서 처리합니다.

```js
// 첫 번째 오류 처리 미들웨어 (데이터베이스 오류 처리)
app.use((err, req, res, next) => {
  if (err.type === "database") {
    // 데이터베이스 관련 오류
    console.error("Database error:", err);
    // 500 상태 코드와 함께 데이터베이스 오류 메시지 전송
    res.status(500).json({ error: "Database error occurred" });
  } else {
    // 이 오류를 처리할 수 없으면, 다음 미들웨어로 넘어갑니다.
    next(err);
  }
});

// 두 번째 오류 처리 미들웨어 (일반적인 오류 처리)
app.use((err, req, res, next) => {
  console.error("General error:", err);
  // 일반적인 오류는 500 상태 코드와 함께 처리
  res.status(500).json({ error: "An error occurred" });
});
```

#### **설명**:
- 첫 번째 미들웨어에서는 `err.type`이 `"database"`일 때만 처리합니다. 만약 데이터베이스 관련 오류라면 **500 상태 코드**와 함께 **데이터베이스 오류** 메시지를 반환합니다.
- **두 번째 미들웨어**는 **일반적인 오류**를 처리하며, `next(err)`가 호출되어 **다음 미들웨어로 넘겨집니다**. 그 이후 이 미들웨어에서 오류를 처리합니다.

---

### **케이스 3: Express에서 초기 미들웨어와 후속 라우터/미들웨어 오류 처리 분리하기**

### 설명:
이 케이스는 **특정 라우트**에 대한 오류 처리 미들웨어와 **일반적인 오류 처리 미들웨어**를 **구분**하는 방법입니다.

#### 동작 흐름:
1. **특정 라우트 (`/special-route`)**에서 오류가 발생하면, **특수 오류 처리 미들웨어**에서 해당 오류를 **상태 코드 400**으로 처리합니다.
2. 다른 라우트에서 발생한 오류는 **전역 오류 처리 미들웨어**에서 처리됩니다.

```js
// 특정 라우트 정의
app.get("/special-route", (req, res, next) => {
  // 라우트 처리 중 오류 발생 시뮬레이션
  const error = new Error("Error in special-route");
  error.status = 400; // 오류 상태 코드 설정
  next(error); // 오류를 오류 처리 미들웨어로 전달
});

// 다른 라우트 정의
app.get("/another-route", (req, res, next) => {
  res.send(
    "This is another route, errors here are not handled by the special handler."
  );
});

// '/special-route' 이후의 오류 처리 미들웨어
app.use("/special-route", (err, req, res, next) => {
  // 오류 상태 코드가 설정되어 있는지 확인
  if (err.status === 400) {
    // 400 상태 코드에 맞는 특수 처리 오류 메시지 응답
    res.status(400).send(`Special error handler: ${err.message}`);
  } else {
    // 다른 오류에 대해서는 다음 오류 처리 미들웨어로 전달
    next(err);
  }
});

// 전역 오류 처리 미들웨어 (모든 오류에 대해 처리)
app.use((err, req, res, next) => {
  console.error(err);
  // 전역적으로 처리할 수 없는 오류는 500 상태 코드와 함께 사용자에게 전송
  res.status(500).send("An unexpected error occurred");
});
```

#### **설명**:
- **특정 라우트 오류 처리**: `/special-route` 경로에서 오류가 발생하면, 해당 라우트의 **특정 오류 처리 미들웨어**에서 **400 상태 코드**와 함께 **특수 처리된 오류 메시지**를 반환합니다.
- **전역 오류 처리**: 다른 라우트에서 발생한 오류는 **전역 오류 처리 미들웨어**에서 **500 상태 코드**로 처리됩니다.

---

## 📊 500 에러 처리 흐름 요약 시각화

```js
🧍 사용자: /some-page 요청 → 서버에서 오류 발생
──────────────────────────────────────
↓
📦 서버:
  - 오류 발생 → next()로 에러 전달
  - 오류 처리 미들웨어로 이동

🧍 사용자: 500 에러 메시지 응답
──────────────────────────────────────
↓
📦 서버:
  - 500 에러 상태 코드와 함께 "Internal Server Error" 메시지 응답
```

---

## 🧪 실제 요청 확인 (브라우저 개발자 도구)

```http
GET /some-page HTTP/1.1
Host: localhost:3000
```

> 만약 **서버에서 오류**가 발생하면, **500 에러**가 발생하고, 사용자에게 **500 Internal Server Error** 메시지를 응답합니다.

---

## 🔐 보안 팁 – 500 에러 처리 시 안전하게 구현하기

| 설정 | 설명 | 추천 여부 |
|------|------|-----------|
| **에러 로그 기록** | **서버의 에러**를 **콘솔에 기록**하여, 개발자가 오류를 추적할 수 있도록 합니다. | ✅ 필수 |
| **디버그 정보 숨기기** | **500 에러 페이지**에 **서버의 내부 디버그 정보**가 노출되지 않도록 주의해야 합니다. | ✅ 필수 |
| **사용자에게 친절한 메시지 제공** | **500 에러**가 발생하더라도, **사용자에게 친절한 메시지**를 제공하여 불안감을 덜어줍니다. | ✅ 필수 |
| **`next(err)` 사용** | 비동기 코드에서 오류가 발생하면 **`next(err)`**를 사용하여 오류를 미들웨어로 전달합니다. | ✅ 필수 |

---

## ✅ Express에서 500 에러 처리 메서드 정리

| 메서드 | 설명 | 예시 |
|--------|------|------|
| **`next(err)`** | 오류를 **다음 미들웨어로 전달**하는 함수입니다. | `next(new Error("Something went wrong!"))` |
| **`res.status(500).send()`** | **500 에러 상태 코드**와 함께 **에러 메시지**를 사용자에게 전달합니다. | `res.status(500).send("Internal Server Error")` |

---

## 🔚 마무리 요약

| 개념 | 설명 |
|------|------|
| 500 에러 페이지 | **서버 오류** 발생 시, **친절한 에러 메시지**를 사용자에게 제공하고, **서버 로그**에 오류를 기록합니다. |
| Express 구현 | **동기/비동기 코드**에서 발생한 오류를 **`next(err)`**를 통해 **에러 처리 미들웨어**로 전달합니다. |
| 보안 관리 | **디버그 정보**를 사용자에게 **노출하지 않도록** 하여 보안을 강화하고, 친절한 오류 메시지로 사용자 경험을 향상시킵니다. |
